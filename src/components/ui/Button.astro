---
import { Icon } from "astro-icon/components";

type ButtonVariant = "filled" | "tonal" | "outline";

export interface Props {
    link?: string;
    text: string;
    iconName?: string;
    iconAfterText?: boolean;
    variant?: ButtonVariant;
    ariaLabel?: string;
    disabled?: boolean;
    isLoading?: boolean;
    isExternal?: boolean;
    isActive?: boolean;
    class?: string;
    scrollTarget?: string;
    onClick?: string;
    animatedBorder?: boolean;
}

const {
    link,
    text,
    iconName,
    iconAfterText = false,
    variant = "filled",
    ariaLabel,
    disabled = false,
    isLoading = false,
    isExternal = false,
    isActive = false,
    class: className = "",
    scrollTarget,
    onClick,
    animatedBorder = false,
} = Astro.props as Props;

// Clases base
const baseClasses = `
    relative inline-flex items-center justify-center
    rounded-full font-medium
    transition-all duration-200 ease-in-out
    cursor-pointer hover:scale-105
    disabled:opacity-50 disabled:cursor-not-allowed
    focus-visible:outline-none focus:ring-2 focus:ring-offset-2
    px-6 py-3
`;

// Variantes específicas los estilos
const variantClasses = {
    filled: `
        bg-primary-500 text-white
        hover:bg-primary-600
        focus:ring-primary-500
        border-transparent
        ${animatedBorder ? 'hover:shadow-lg hover:shadow-cream-300/30' : ''}
    `,
    tonal: `
        bg-secondary-100 text-secondary-900
        hover:bg-secondary-200 
        focus:ring-secondary-500
        border border-transparent
        ${animatedBorder ? ' hover:shadow-lg hover:shadow-secondary-500/30' : ''}
    `,
    outline: `
        bg-accent-50
        border border-primary-500 text-primary-500
        hover:bg-primary-100
        focus:ring-primary-500
        ${animatedBorder ? 'hover:shadow-lg hover:shadow-primary-500/30' : ''}
    `
};

// Clases de borde animado
const borderAnimationClasses = {
    filled: `
        w-fit h-fit
        bg-conic-primary
        animate-rotate-border
        p-px
        rounded-full
    `,
    tonal: `
        w-fit h-fit
        bg-conic-secondary
        animate-rotate-border
        p-px
        rounded-full
    `,
    outline: `
        w-fit h-fit
        bg-conic-outline
        animate-rotate-border
        p-px
        rounded-full
    `
}

// Clases para iconos
const iconClasses = "w-5 h-5";

const buttonClasses = `${baseClasses} ${variantClasses[variant]} ${className}`;

// Generar aria-label si no se proporciona
const buttonAriaLabel = ariaLabel || (iconName ? `${text} ${iconName}` : text);

// Determinar si es un enlace externo
const isExternalLink = isExternal || (link && link.startsWith('http'));

// Atributos adicionales para enlaces externos
const externalAttributes = isExternalLink ? {
    target: '_blank',
    rel: 'noopener noreferrer'
} : {};

// Estado de carga
const loadingText = isLoading ? 'Cargando...' : text;
const loadingAriaLabel = isLoading 
    ? `${buttonAriaLabel} - Cargando` 
    : buttonAriaLabel
;

// Determinar el onclick
const onClickHandler = onClick || (scrollTarget ? `scrollToSection('${scrollTarget}')` : undefined);


// Determinar si usar enlace o botón
const useButton = !link || scrollTarget || onClick;
---

{animatedBorder ? (
    <div class={borderAnimationClasses[variant]}>
        {useButton ? (
            <button
                class:list={buttonClasses}
                onclick={onClickHandler}
                aria-label={loadingAriaLabel}
                disabled={disabled}
                aria-disabled={disabled}
                aria-busy={isLoading}
                aria-pressed={isActive}
            >
                {iconAfterText ? (
                    <>
                        {loadingText}
                        {iconName && 
                            <Icon 
                                name={iconName} 
                                class={`${iconClasses} ml-2`} 
                                aria-hidden="true" 
                            />
                        }
                        {isLoading && 
                            <Icon 
                                name="mdi:loading" 
                                class="animate-spin w-5 h-5 ml-2" 
                                aria-hidden="true" 
                            />
                        }
                    </>
                ) : (
                    <>
                        {iconName && 
                            <Icon 
                                name={iconName} 
                                class={`${iconClasses} mr-2`} 
                                aria-hidden="true" 
                            />
                        }
                        {isLoading && 
                            <Icon 
                                name="mdi:loading" 
                                class="animate-spin w-5 h-5 mr-2" 
                                aria-hidden="true" 
                            />
                        }
                        {loadingText}
                    </>
                )}
            </button>
        ) : (
            <a
                class:list={buttonClasses}
                href={disabled ? '#' : link}
                aria-label={loadingAriaLabel}
                role="button"
                aria-disabled={disabled}
                aria-busy={isLoading}
                aria-pressed={isActive}
                {...externalAttributes}
            >
                {iconAfterText ? (
                    <>
                        {loadingText}
                        {iconName && 
                            <Icon 
                                name={iconName} 
                                class={`${iconClasses} ml-2`} 
                                aria-hidden="true" 
                            />
                        }
                        {isLoading && 
                            <Icon 
                                name="mdi:loading" 
                                class="animate-spin w-5 h-5 ml-2" 
                                aria-hidden="true" 
                            />
                        }
                    </>
                ) : (
                    <>
                        {iconName && 
                            <Icon 
                                name={iconName} 
                                class={`${iconClasses} mr-2`} 
                                aria-hidden="true" 
                            />
                        }
                        {isLoading && 
                            <Icon 
                                name="mdi:loading" 
                                class="animate-spin w-5 h-5 mr-2" 
                                aria-hidden="true" 
                            />
                        }
                        {loadingText}
                    </>
                )}
            </a>
        )}
    </div>
) : (
    <>
        {useButton ? (
            <button
                class:list={buttonClasses}
                onclick={onClickHandler}
                aria-label={loadingAriaLabel}
                disabled={disabled}
                aria-disabled={disabled}
                aria-busy={isLoading}
                aria-pressed={isActive}
            >
                {iconAfterText ? (
                    <>
                        {loadingText}
                        {iconName && 
                            <Icon 
                                name={iconName} 
                                class={`${iconClasses} ml-2`} 
                                aria-hidden="true" 
                            />
                        }
                        {isLoading && 
                            <Icon 
                                name="mdi:loading" 
                                class="animate-spin w-5 h-5 ml-2" 
                                aria-hidden="true" 
                            />
                        }
                    </>
                ) : (
                    <>
                        {iconName && 
                            <Icon 
                                name={iconName} 
                                class={`${iconClasses} mr-2`} 
                                aria-hidden="true" 
                            />
                        }
                        {isLoading && 
                            <Icon 
                                name="mdi:loading" 
                                class="animate-spin w-5 h-5 mr-2" 
                                aria-hidden="true" 
                            />
                        }
                        {loadingText}
                    </>
                )}
            </button>
        ) : (
            <a
                class:list={buttonClasses}
                href={disabled ? '#' : link}
                aria-label={loadingAriaLabel}
                role="button"
                aria-disabled={disabled}
                aria-busy={isLoading}
                aria-pressed={isActive}
                {...externalAttributes}
            >
                {iconAfterText ? (
                    <>
                        {loadingText}
                        {iconName && 
                            <Icon 
                                name={iconName} 
                                class={`${iconClasses} ml-2`} 
                                aria-hidden="true" 
                            />
                        }
                        {isLoading && 
                            <Icon 
                                name="mdi:loading" 
                                class="animate-spin w-5 h-5 ml-2" 
                                aria-hidden="true" 
                            />
                        }
                    </>
                ) : (
                    <>
                        {iconName && 
                            <Icon 
                                name={iconName} 
                                class={`${iconClasses} mr-2`} 
                                aria-hidden="true" 
                            />
                        }
                        {isLoading && 
                            <Icon 
                                name="mdi:loading" 
                                class="animate-spin w-5 h-5 mr-2" 
                                aria-hidden="true" 
                            />
                        }
                        {loadingText}
                    </>
                )}
            </a>
        )}
    </>
)}

<script is:inline>
    window.scrollToSection = (id) => {
        const el = document.getElementById(id);
        if (el) {
            el.scrollIntoView({ behavior: "smooth" });
        }
    };
</script>
